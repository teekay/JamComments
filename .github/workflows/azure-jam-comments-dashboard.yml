name: Deploy JamComments dashboard to Azure App Service

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Name of environment to deploy (staging, prod)'
        required: true
        default: 'staging'
      fullDeployment:
        description: 'Whether to do a full deployment or not'
        required: true
        default: 'false'
  push:
    branches:
      - dev
      - master
    paths:
      - 'infra/azure/apps/admin/**'
      - '.github/workflows/azure-jam-comments-dashboard.yml'
      - 'assets/**'
      - 'public/**'
      - 'sql/**'
      - 'src/**'
      - 'test/**'

env:
  AZURE_WEBAPP_PACKAGE_PATH: '.'      # set this to the path to your web app project, defaults to the repository root
  NODE_VERSION: '14.x'                # set this to the node version to use
  fullDeployment: ${{ github.event.inputs.fullDeployment || 'false' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: Install dependencies, build and test
      run: |
        yarn
        yarn build
        yarn test

    - name: Azure Login
      timeout-minutes: 5
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create infrastructure
      run:  infra/azure/apps/admin/scripts/create-webapp.sh
      env:
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    - name: Azure Logout
      if: ${{ always() }}
      run: |
        az logout
        az cache purge
        az account clear
    